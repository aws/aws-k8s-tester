apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: containerd-check
  namespace: default
  labels:
    app: containerd-check
spec:
  selector:
    matchLabels:
      app: containerd-check
  template:
    metadata:
      labels:
        app: containerd-check
    spec:
      containers:
      - name: containerd-check
        image: public.ecr.aws/amazonlinux/amazonlinux:latest
        command:
        - sh
        - -c
        - |
          # 1. Ensure the script fails on any command or pipeline error
          set -e
          set -o pipefail

          echo "=== content read by the container ==="
          cat /host-etc/containerd/config.toml

          # 2. Check containerd config version and look for appropriate sandbox field
          #    In containerd config version = 2 expect to find pattern `sandbox_image = "registry.k8s.io/pause:3.10.1"`
          #    In containerd config version = 3 expect to find pattern `sandbox = "registry.k8s.io/pause:3.10.1"`
          #    For more details: https://github.com/containerd/containerd/blob/main/docs/cri/config.md
          version_line=$(grep -E '^version\s*=' /host-etc/containerd/config.toml || true)
          if [ -z "$version_line" ]; then
            echo "FAIL: no version line found in containerd config"
            exit 1
          fi

          version=$(echo "$version_line" | cut -d'=' -f2 | tr -d ' ')
          echo "INFO: containerd config version = $version"
          if [ "$version" = "2" ]; then
            sandbox_line=$(grep -E 'sandbox_image\s*=' /host-etc/containerd/config.toml || true)
            field_name="sandbox_image"
          elif [ "$version" = "3" ]; then
            sandbox_line=$(grep -E 'sandbox\s*=' /host-etc/containerd/config.toml || true)
            field_name="sandbox"
          else
            echo "FAIL: unsupported containerd config version: $version"
            exit 1
          fi

          # 3. If no sandbox configuration is found, fail explicitly
          if [ -z "$sandbox_line" ]; then
            echo "FAIL: no sandbox_image or sandbox line found"
            echo "=== debug ==="
            exit 1
          fi
          sandbox_image=$(echo "$sandbox_line" | cut -d'"' -f2)

          # 4. Check that $sandbox_image references .ecr. or is provided on the instance
          if [[ "$sandbox_image" == "localhost"* ]]; then
            echo "INFO: skipping .ecr. check for localhost sandbox image"
          else
            if [[ "$sandbox_image" != *".ecr."* ]]; then
              echo "FAIL: no .ecr. reference in $sandbox_image"
              echo "=== debug ==="
              exit 1
            fi
          fi

          # 5. Check for 'nvidia-container-runtime'
          if ! grep -q "nvidia-container-runtime" /host-etc/containerd/config.toml; then
            echo "FAIL: no nvidia-container-runtime found"
            echo "=== debug ==="
            exit 1
          fi

          # 6. Check for 'systemd_cgroup = true' or 'SystemdCgroup = true'
          if ! ( grep -q 'systemd_cgroup = true' /host-etc/containerd/config.toml || \
                 grep -q 'SystemdCgroup = true' /host-etc/containerd/config.toml ); then
            echo "FAIL: no systemd cgroup setting"
            echo "=== debug ==="
            exit 1
          fi

          echo "containerd config check PASSED."
          # Keep container running so DS can be marked Ready
          tail -f /dev/null
        volumeMounts:
        - name: containerd-config
          mountPath: /host-etc/containerd
          readOnly: true
      volumes:
      - name: containerd-config
        hostPath:
          path: /etc/containerd
