apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: containerd-check
  namespace: default
  labels:
    app: containerd-check
spec:
  selector:
    matchLabels:
      app: containerd-check
  template:
    metadata:
      labels:
        app: containerd-check
    spec:
      containers:
      - name: grep-containerd
        image: public.ecr.aws/docker/library/busybox:latest
        command:
        - sh
        - -c
        - |
          rc=0
          echo "=== content read by the container ==="
          cat /host-etc/containerd/config.toml

          grep -Eq '\.ecr\.' /host-etc/containerd/config.toml || {
            echo "FAIL: no .ecr. reference in sandbox_image"
            rc=1
          }

          grep -q 'nvidia-container-runtime' /host-etc/containerd/config.toml || {
            echo "FAIL: no nvidia-container-runtime found"
            rc=1
          }

          ( grep -q 'systemd_cgroup = true' /host-etc/containerd/config.toml \
            || grep -q 'SystemdCgroup = true' /host-etc/containerd/config.toml ) || {
            echo "FAIL: no systemd cgroup setting"
            rc=1
          }

          if [ "$rc" -ne 0 ]; then
            echo "=== debug ==="
            exit 1
          fi

          echo "containerd config check PASSED."
          tail -f /dev/null   # Keep the pod running so DS can be marked Ready

        volumeMounts:
        - name: containerd-config
          mountPath: /host-etc/containerd
          readOnly: true
      volumes:
      - name: containerd-config
        hostPath:
          path: /etc/containerd
