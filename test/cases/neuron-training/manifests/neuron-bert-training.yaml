apiVersion: kubeflow.org/v2beta1
kind: MPIJob
metadata:
  name: neuron-training
spec:
  slotsPerWorker: {{.SlotsPerWorker}}
  runPolicy:
    backoffLimit: 20
    cleanPodPolicy: Running
  mpiReplicaSpecs:
    Launcher:
      replicas: 1
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: neuron-bert-training
              image: {{.BertTrainingImage}}
              imagePullPolicy: Always
              env:
                - name: NCCL_DEBUG
                  value: "TRACE"
                - name: MASTER_ADDR
                  value: "neuron-training"
                - name: NEURON_RT_NUM_CORES
                  value: "1"
              command:
                - /bin/sh
              args:
                - -c
                - |
                  echo "Launcher: Running mpirun for BERT training..."
                  /opt/amazon/openmpi/bin/mpirun --tag-output \
                    --allow-run-as-root \
                    -np {{.NP}} \
                    -bind-to none \
                    -map-by slot \
                    -x PATH \
                    -x LD_LIBRARY_PATH \
                    -x NCCL_DEBUG \
                    -x NEURON_RT_NUM_CORES \
                    --mca pml "^cm" \
                    --mca routed direct \
                    --oversubscribe \
                    --mca orte_base_help_aggregate 0 \
                    python train.py
    Worker:
      replicas: {{.WorkerReplicas}}
      template:
        spec:
          volumes:
            - name: dshm
              emptyDir:
                medium: Memory
          containers:
            - name: neuron-bert-training-worker
              image: {{.BertTrainingImage}}
              imagePullPolicy: Always
              volumeMounts:
                - mountPath: /dev/shm
                  name: dshm
              resources:
                requests:
                  aws.amazon.com/neuron: {{.NeuronPerNode}}
                  aws.amazon.com/neuroncore: {{.NeuronCorePerNode}}
                  vpc.amazonaws.com/efa: {{.EFARequested}}
                limits:
                  aws.amazon.com/neuron: {{.NeuronPerNode}}
                  aws.amazon.com/neuroncore: {{.NeuronCorePerNode}}
                  vpc.amazonaws.com/efa: {{.EFARequested}}
          nodeSelector:
            node.kubernetes.io/instance-type: {{.NodeType}}